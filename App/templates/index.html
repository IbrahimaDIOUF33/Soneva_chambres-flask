<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Liste des chambres</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <meta name="theme-color" content="#008080">
</head>
<body>
    <nav class="navbar">
        <a href="{{ url_for('index') }}">üè† Accueil</a>
        <a href="{{ url_for('historique') }}">üìú Historique</a>
    </nav>

    <h1>Chambres</h1>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul>
        {% for message in messages %}
          <li style="color: {% if '‚úÖ' in message %}green{% else %}red{% endif %};">
            {{ message }}
          </li>
        {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <table>
        <tr>
            <th>Num√©ro</th>
            <th>√âtat</th>
            <th>Actions</th>
            <th class="desktop-only">Client</th>
            <th class="desktop-only">D√©but</th>
            <th class="desktop-only">Fin</th>
            <th class="desktop-only">Tarif</th>
            <th class="desktop-only">Identit√©</th>
            <th class="desktop-only">Adresse</th>
        </tr>
        {% for chambre in chambres %}
        <tr style="background-color: {{ chambre.status_color }};">
            <td>{{ chambre.numero }}</td>
            <td>{{ chambre.etat_libelle }}</td>
            <td class="actions">
                <div class="form-rapide">
                    {% if chambre.etat == 'libre' %}
                    <div class="action-row full-width">
                        <a href="{{ url_for('reserver', id=chambre.id) }}" class="action-button">R√©server</a>
                        <button class="action-button" onclick="ouvrirCamera({{ chambre.id }})">üì∏</button>
                    </div>
                    {% else %}
                    <div class="action-row full-width">
                        <button class="action-button" style="margin-right:auto;" onclick="afficherDetails({{ chambre.id }})">D√©tails</button>
                        <form method="POST" action="{{ url_for('liberer', id=chambre.id) }}">
                            <button type="submit" class="action-button liberer-button" style="margin-left:auto;" onclick="return confirm('Lib√©rer cette chambre ?')">Lib√©rer</button>
                        </form>
                    </div>
                    {% endif %}

                    {% if chambre.temps_restant %}
                    <div class="temps">‚è≥ {{ chambre.temps_restant }} restantes</div>
                    {% endif %}

                    {% if chambre.depass√© %}
                    <div class="depasser">‚ö†Ô∏è D√©pass√©</div>
                    {% endif %}
                </div>
            </td>
            <td class="desktop-only">{{ chambre.client or '‚Äî' }}</td>
            <td class="desktop-only">{{ chambre.debut_affichage }}</td>
            <td class="desktop-only">{{ chambre.fin_affichage }}</td>
            <td class="desktop-only">{{ chambre.tarif or '‚Äî' }}</td>
            <td class="desktop-only">{{ chambre.identite or '‚Äî' }}</td>
            <td class="desktop-only">{{ chambre.adresse or '‚Äî' }}</td>
        </tr>
        {% endfor %}
    </table>

    {% for chambre in chambres %}
    <div class="modal-carte" id="modal-{{ chambre.id }}">
        <div class="modal-content">
            <h2>Chambre {{ chambre.numero }}</h2>
            <table class="carte-table">
                <tr><td><strong>√âtat :</strong></td><td>{{ chambre.etat_libelle }}</td></tr>
                <tr><td><strong>Client :</strong></td><td>{{ chambre.client or '‚Äî' }}</td></tr>
                <tr><td><strong>D√©but :</strong></td><td>{{ chambre.debut_affichage }}</td></tr>
                <tr><td><strong>Fin :</strong></td><td>{{ chambre.fin_affichage }}</td></tr>
                <tr><td><strong>Tarif :</strong></td><td>{{ chambre.tarif or '‚Äî' }}</td></tr>
                <tr><td><strong>Identit√© :</strong></td><td>{{ chambre.identite or '‚Äî' }}</td></tr>
                <tr><td><strong>Adresse :</strong></td><td>{{ chambre.adresse or '‚Äî' }}</td></tr>
                <tr><td><strong>Agent :</strong></td><td>{{ chambre.agent or '‚Äî' }}</td></tr>
                <tr><td><strong>Observations :</strong></td><td>{{ chambre.observations or '‚Äî' }}</td></tr>
            </table>
            <div style="margin-top: 10px;">
                <a href="{{ url_for('reserver', id=chambre.id) }}"><button class="action-button">Modifier</button></a>
                <button onclick="fermerDetails({{ chambre.id }})" class="action-button">Retour</button>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Modal Cam√©ra globale -->
    <div id="modal-camera" class="modal-carte" style="display:none;">
        <div class="modal-content">
            <h3>Capturer la photo du client</h3>
            <video id="camera" width="100%" autoplay></video>
            <canvas id="canvas" style="display:none;"></canvas>
            <div style="margin-top: 10px;">
                <button onclick="capturerPhoto()" class="action-button">Capturer</button>
                <button onclick="fermerCamera()" class="action-button">Annuler</button>
            </div>
        </div>
    </div>

    <script>
        function afficherDetails(id) {
            document.getElementById("modal-" + id).style.display = "block";
        }
        function fermerDetails(id) {
            document.getElementById("modal-" + id).style.display = "none";
        }

        let chambreEnCours = null;
        let stream = null;

        function ouvrirCamera(chambreId) {
            chambreEnCours = chambreId;
            document.getElementById("modal-camera").style.display = "block";
            navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } })

                .then(s => {
                    stream = s;
                    document.getElementById("camera").srcObject = stream;
                })
                .catch(err => alert("Erreur acc√®s cam√©ra"));
        }

        function fermerCamera() {
            document.getElementById("modal-camera").style.display = "none";
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
            }
        }

        function capturerPhoto() {
            let video = document.getElementById("camera");
            let canvas = document.getElementById("canvas");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            let imageData = canvas.toDataURL("image/png");

            fetch(`/enregistrer_photo/${chambreEnCours}`, {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: imageData })
            }).then(resp => {
                if (resp.ok) alert("Photo enregistr√©e ‚úÖ");
                else alert("Erreur lors de l'envoi");
                fermerCamera();
            });
        }

        setInterval(function() {
            window.location.reload();
        }, 120000);
    </script>
</body>
<!-- Force update Render -->
</html>
